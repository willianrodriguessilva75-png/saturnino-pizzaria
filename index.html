<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saturnino V4</title>
    
    <!-- Configura√ß√£o PWA -->
    <meta name="theme-color" content="#d97706">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Estilos e √çcones -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Motor de Leitura (OCR) -->
    <script src='https://unpkg.com/tesseract.js@v4.1.1/dist/tesseract.min.js'></script>
    <!-- Data e Hora -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #d97706; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans pb-24">

    <!-- Topo -->
    <header class="bg-yellow-600 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div>
            <h1 class="font-bold text-lg flex items-center gap-2"><i data-lucide="pizza"></i> Saturnino V4</h1>
            <p id="nome-colaborador" class="text-xs opacity-90">Toque na engrenagem ‚öôÔ∏è</p>
        </div>
        <button onclick="abrirConfig()" class="p-2"><i data-lucide="settings"></i></button>
    </header>

    <!-- √Årea Principal -->
    <main class="p-4 max-w-md mx-auto">
        
        <!-- BOT√ÉO DE C√ÇMERA (M√©todo Label - Funciona em todos os celulares) -->
        <div class="mb-6">
            <label for="camera-input" class="block w-full bg-white border-2 border-dashed border-yellow-500 rounded-xl p-6 text-center shadow-lg active:bg-yellow-50 transition cursor-pointer">
                <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2 text-yellow-700">
                    <i data-lucide="camera" size="32"></i>
                </div>
                <h2 class="font-bold text-lg text-gray-700">Ler Comanda</h2>
                <p class="text-xs text-gray-400">Clique aqui para fotografar</p>
            </label>
            <!-- O input fica escondido, mas o Label dispara ele -->
            <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="processarFoto(this)">
        </div>

        <!-- Aviso de Carregamento -->
        <div id="loading-box" class="hidden bg-white p-4 rounded-lg shadow text-center mb-4 border border-blue-200">
            <div class="loader mb-2"></div>
            <p class="text-blue-600 font-bold text-sm animate-pulse">Lendo imagem... Aguarde.</p>
        </div>

        <!-- Lista de Pedidos -->
        <div class="flex justify-between items-end mb-2 px-1">
            <h3 class="font-bold text-gray-600 flex items-center gap-1"><i data-lucide="flame" size="16"></i> No Forno</h3>
            <span class="text-xs text-gray-400" id="contador-pedidos">0 pizzas</span>
        </div>
        
        <div id="lista-pedidos" class="space-y-3 min-h-[100px]">
            <!-- Os pedidos v√£o aparecer aqui -->
            <p class="text-center text-gray-400 text-sm py-10">Nenhum pedido em produ√ß√£o.</p>
        </div>
    </main>

    <!-- Modal de Pedido (Formul√°rio) -->
    <div id="modal-form" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-xl p-5 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-xl" id="titulo-modal">Novo Pedido</h3>
                <button onclick="fecharModal()" class="text-gray-500"><i data-lucide="x"></i></button>
            </div>

            <form onsubmit="salvarFormulario(event)">
                <input type="hidden" id="idx-pedido"> <!-- -1 = novo -->
                <input type="hidden" id="data-inicio-oculta">

                <div class="grid gap-4">
                    <!-- Numero -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">N√∫mero do Pedido</label>
                        <input type="tel" id="inp-numero" class="w-full border-2 border-gray-300 p-3 rounded-lg text-xl font-bold focus:border-yellow-500 outline-none" placeholder="Digite se n√£o leu..." required>
                    </div>

                    <!-- Hora Plataforma -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Hora na Plataforma (Ifood/99)</label>
                        <input type="time" id="inp-hora-plat" class="w-full border p-2 rounded-lg bg-gray-50">
                    </div>

                    <!-- Sabor e Tamanho -->
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Sabor</label>
                            <input type="text" id="inp-sabor" class="w-full border p-2 rounded-lg" placeholder="Calabresa..." required>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Tamanho</label>
                            <select id="inp-tamanho" class="w-full border p-2 rounded-lg bg-white h-[42px]">
                                <option value="Grande">Grande</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Broto">Broto</option>
                                <option value="Gigante">Gigante</option>
                            </select>
                        </div>
                    </div>

                    <!-- Respons√°vel -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Pizzaiolo</label>
                        <select id="inp-responsavel" class="w-full border p-2 rounded-lg bg-white"></select>
                    </div>
                </div>

                <div class="mt-6 flex gap-2">
                    <button type="button" id="btn-excluir" onclick="excluirPedido()" class="hidden bg-red-100 text-red-600 px-4 rounded-lg font-bold"><i data-lucide="trash-2"></i></button>
                    <button type="submit" class="flex-1 bg-yellow-600 text-white py-3 rounded-lg font-bold text-lg shadow-md">CONFIRMAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Configura√ß√µes -->
    <div id="modal-config" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-xl p-6">
            <h3 class="font-bold text-lg mb-4">Configura√ß√µes</h3>
            
            <label class="block text-sm font-bold mb-1">Quem est√° usando agora?</label>
            <select id="conf-responsavel" class="w-full border p-2 rounded mb-2" onchange="mudarUsuario(this.value)"></select>
            
            <div class="flex gap-2 mb-6">
                <input type="text" id="novo-user" placeholder="Novo nome..." class="border p-2 flex-1 rounded text-sm">
                <button onclick="addUsuario()" class="bg-green-600 text-white px-3 rounded font-bold text-sm">Add</button>
            </div>

            <hr class="mb-4">
            
            <div class="bg-gray-50 p-3 rounded mb-4">
                <p class="text-sm"><b>Produzidas Hoje:</b> <span id="rel-qtd">0</span></p>
                <p class="text-sm"><b>Tempo M√©dio:</b> <span id="rel-tempo">0 min</span></p>
            </div>

            <button onclick="enviarZap()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold mb-2 flex justify-center gap-2">
                <i data-lucide="message-circle"></i> Relat√≥rio WhatsApp
            </button>
            
            <button onclick="document.getElementById('modal-config').classList.add('hidden')" class="w-full text-gray-500 py-2">Fechar</button>
        </div>
    </div>

    <script>
        // --- DADOS ---
        let dados = {
            usuarios: JSON.parse(localStorage.getItem('sat_users')) || ['Pizzaiolo 1'],
            usuarioAtual: localStorage.getItem('sat_atual') || '',
            forno: JSON.parse(localStorage.getItem('sat_forno')) || [],
            historico: JSON.parse(localStorage.getItem('sat_hist')) || []
        };

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            lucide.createIcons();
            carregarTela();
        }

        function carregarTela() {
            // Header
            const nomeDisplay = document.getElementById('nome-colaborador');
            nomeDisplay.innerText = dados.usuarioAtual ? `Ol√°, ${dados.usuarioAtual}` : "‚ö†Ô∏è Selecione o usu√°rio!";
            nomeDisplay.style.color = dados.usuarioAtual ? 'white' : '#fee2e2';

            // Lista Forno
            const lista = document.getElementById('lista-pedidos');
            const contador = document.getElementById('contador-pedidos');
            lista.innerHTML = '';
            contador.innerText = dados.forno.length + ' pizzas';

            if (dados.forno.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-400 py-8 bg-white rounded-xl border border-dashed border-gray-300">Nenhum pedido no forno.</div>';
            } else {
                dados.forno.forEach((p, index) => {
                    const horaInicio = dayjs(p.inicio).format('HH:mm');
                    lista.innerHTML += `
                        <div onclick="abrirEdicao(${index})" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500 relative cursor-pointer active:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-black text-2xl text-gray-800">#${p.numero}</span>
                                    <p class="font-bold text-gray-600">${p.sabor}</p>
                                    <p class="text-xs text-gray-400 mt-1">${p.tamanho} ‚Ä¢ ${horaInicio} ‚Ä¢ ${p.responsavel}</p>
                                </div>
                                <div class="text-right">
                                    <span class="bg-orange-100 text-orange-600 text-xs font-bold px-2 py-1 rounded animate-pulse">Assando</span>
                                    <p class="text-xs text-gray-400 mt-2">Plat: ${p.horaPlat || '--:--'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            lucide.createIcons();
        }

        // --- C√ÇMERA E OCR ---
        async function processarFoto(input) {
            if (!dados.usuarioAtual) {
                alert("Selecione seu nome na engrenagem antes de come√ßar!");
                abrirConfig();
                input.value = "";
                return;
            }

            const arquivo = input.files[0];
            if (!arquivo) return;

            // Mostra Loading
            document.getElementById('loading-box').classList.remove('hidden');

            try {
                // Tenta Ler com Tesseract
                const worker = await Tesseract.createWorker('por');
                const resultado = await worker.recognize(arquivo);
                await worker.terminate();
                
                const texto = resultado.data.text;
                console.log("Texto OCR:", texto);

                // Extrai dados (Regex Simples)
                const numero = extrairNumero(texto);
                const horaPlat = extrairHora(texto);

                // Verifica se j√° existe no forno
                const index = dados.forno.findIndex(p => p.numero == numero);
                
                // Abre o modal (com dados ou vazio)
                abrirModalPedido(index, numero, horaPlat);

            } catch (erro) {
                console.error(erro);
                alert("N√£o consegui ler a foto. Digite os dados manualmente.");
                abrirModalPedido(-1, "", "");
            } finally {
                document.getElementById('loading-box').classList.add('hidden');
                input.value = ""; // Limpa para permitir nova foto
            }
        }

        function extrairNumero(t) {
            // Remove espa√ßos e busca padr√£o de 3 a 5 digitos
            let limpo = t.replace(/\s/g, '');
            let match = limpo.match(/(?:pedido|senha|cupom|n¬∫|#)[:\.-]*(\d{3,5})/i);
            if (match) return match[1];
            // Tenta numero solto
            let match2 = t.match(/\b\d{3,5}\b/);
            return match2 ? match2[0] : "";
        }

        function extrairHora(t) {
            let match = t.match(/(\d{2}:\d{2})/);
            return match ? match[1] : "";
        }

        // --- FORMUL√ÅRIO E SALVAMENTO ---
        function abrirModalPedido(index, numeroSugest, horaSugest) {
            const modal = document.getElementById('modal-form');
            const titulo = document.getElementById('titulo-modal');
            const btnExcluir = document.getElementById('btn-excluir');
            
            // Popula Lista de Usu√°rios no Select
            const selUser = document.getElementById('inp-responsavel');
            selUser.innerHTML = '';
            dados.usuarios.forEach(u => selUser.innerHTML += `<option value="${u}">${u}</option>`);

            document.getElementById('idx-pedido').value = index;

            // SE FOR NOVO (Inicio)
            if (index === -1) {
                titulo.innerText = "üî• Iniciar Produ√ß√£o";
                titulo.className = "font-bold text-xl text-yellow-600";
                
                document.getElementById('inp-numero').value = numeroSugest || "";
                document.getElementById('inp-hora-plat').value = horaSugest || "";
                document.getElementById('inp-sabor').value = "";
                document.getElementById('inp-tamanho').value = "Grande";
                document.getElementById('data-inicio-oculta').value = new Date().toISOString();
                
                selUser.value = dados.usuarioAtual;
                document.getElementById('inp-numero').readOnly = false;
                btnExcluir.classList.add('hidden');
            } 
            // SE J√Å EXISTE (Finalizar ou Editar)
            else {
                titulo.innerText = "‚úÖ Finalizar Pedido";
                titulo.className = "font-bold text-xl text-green-600";
                
                const p = dados.forno[index];
                document.getElementById('inp-numero').value = p.numero;
                document.getElementById('inp-hora-plat').value = p.horaPlat;
                document.getElementById('inp-sabor').value = p.sabor;
                document.getElementById('inp-tamanho').value = p.tamanho;
                document.getElementById('data-inicio-oculta').value = p.inicio;
                selUser.value = p.responsavel; // Pode trocar se quiser

                // document.getElementById('inp-numero').readOnly = true; // Bloqueia numero
                btnExcluir.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
        }

        function abrirEdicao(index) {
            // Atalho para clicar no card
            const p = dados.forno[index];
            abrirModalPedido(index, p.numero, p.horaPlat);
        }

        function salvarFormulario(e) {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('idx-pedido').value);
            const numero = document.getElementById('inp-numero').value;
            const horaPlat = document.getElementById('inp-hora-plat').value;
            const sabor = document.getElementById('inp-sabor').value;
            const tamanho = document.getElementById('inp-tamanho').value;
            const responsavel = document.getElementById('inp-responsavel').value;
            const inicio = document.getElementById('data-inicio-oculta').value;

            // NOVO PEDIDO
            if (index === -1) {
                if(dados.forno.some(p => p.numero == numero)) {
                    alert("Esse n√∫mero j√° est√° no forno!");
                    return;
                }
                dados.forno.push({
                    numero, horaPlat, sabor, tamanho, responsavel, inicio
                });
            } 
            // FINALIZAR PEDIDO (Move para historico)
            else {
                // Aqui assumimos que se abriu e salvou, finalizou.
                // Se quisesse s√≥ editar, precisaria de outro bot√£o. 
                // Para simplificar: Salvar = Finalizar.
                const agora = new Date();
                const iniDate = new Date(inicio);
                const duracao = Math.round((agora - iniDate) / 60000) || 1;

                dados.historico.push({
                    numero, horaPlat, sabor, tamanho, responsavel, inicio, 
                    fim: agora.toISOString(), duracao
                });
                
                // Remove do forno
                dados.forno.splice(index, 1);
            }

            salvarDados();
            carregarTela();
            fecharModal();
        }

        function excluirPedido() {
            if(confirm("Excluir este pedido da produ√ß√£o?")) {
                const index = parseInt(document.getElementById('idx-pedido').value);
                dados.forno.splice(index, 1);
                salvarDados();
                carregarTela();
                fecharModal();
            }
        }

        function fecharModal() {
            document.getElementById('modal-form').classList.add('hidden');
        }

        // --- CONFIG E RELATORIOS ---
        function salvarDados() {
            localStorage.setItem('sat_users', JSON.stringify(dados.usuarios));
            localStorage.setItem('sat_atual', dados.usuarioAtual);
            localStorage.setItem('sat_forno', JSON.stringify(dados.forno));
            localStorage.setItem('sat_hist', JSON.stringify(dados.historico));
        }

        function abrirConfig() {
            const modal = document.getElementById('modal-config');
            const sel = document.getElementById('conf-responsavel');
            
            // Popula users
            sel.innerHTML = '<option value="">Selecione...</option>';
            dados.usuarios.forEach(u => {
                sel.innerHTML += `<option value="${u}" ${u == dados.usuarioAtual ? 'selected' : ''}>${u}</option>`;
            });

            // Atualiza resumo
            const hoje = dayjs().format('YYYY-MM-DD');
            const doDia = dados.historico.filter(p => p.fim.startsWith(hoje));
            document.getElementById('rel-qtd').innerText = doDia.length;
            
            const totalMin = doDia.reduce((acc, p) => acc + p.duracao, 0);
            const media = doDia.length ? Math.round(totalMin / doDia.length) : 0;
            document.getElementById('rel-tempo').innerText = media + " min";

            modal.classList.remove('hidden');
        }

        function mudarUsuario(nome) {
            dados.usuarioAtual = nome;
            salvarDados();
            carregarTela();
        }

        function addUsuario() {
            const novo = document.getElementById('novo-user').value;
            if(novo) {
                dados.usuarios.push(novo);
                salvarDados();
                abrirConfig(); // recarrega lista
                document.getElementById('novo-user').value = '';
            }
        }

        function enviarZap() {
            const hoje = dayjs().format('YYYY-MM-DD');
            const doDia = dados.historico.filter(p => p.fim.startsWith(hoje));
            
            if(!doDia.length) return alert("Sem vendas hoje!");

            let texto = `*Resumo Saturnino - ${dayjs().format('DD/MM')}*\n`;
            texto += `Total: ${doDia.length} pizzas\n`;
            
            // Agrupar por pizzaiolo
            let porUser = {};
            doDia.forEach(p => {
                porUser[p.responsavel] = (porUser[p.responsavel] || 0) + 1;
            });

            for(let u in porUser) {
                texto += `- ${u}: ${porUser[u]}\n`;
            }

            window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank');
        }

    </script>
</body>
</html>
